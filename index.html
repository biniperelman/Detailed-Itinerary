<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gap Year Itinerary Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better aesthetics */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        .tab-button.active {
            background-color: #10b981; /* Emerald 500 */
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        /* Timeline styling */
        .timeline-item {
            border-left: 2px solid #d1d5db; /* gray-300 */
            padding-left: 1.5rem;
            position: relative;
        }
        .timeline-dot {
            position: absolute;
            left: -8px;
            top: 0;
            width: 16px;
            height: 16px;
            background-color: #10b981; /* Emerald 500 */
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 0 0 2px #10b981;
        }
        /* Collapsible section transition */
        .further-details-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
        }
        .further-details-content.open {
            max-height: 500px; /* Arbitrarily large value to allow content */
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            transition: max-height 0.5s ease-in, padding 0.5s ease-in;
        }
    </style>
</head>
<body class="bg-gray-50">

<div id="loadingIndicator" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
    <div class="flex flex-col items-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-emerald-500"></div>
        <p class="mt-4 text-emerald-600 font-semibold">Loading Itinerary Data from Google Sheets...</p>
    </div>
</div>

<div class="container">
    <header class="text-center mb-10 p-6 bg-white shadow-lg rounded-xl">
        <h1 class="text-4xl font-extrabold text-gray-800">Gap Year UK Itinerary</h1>
        <p class="text-lg text-gray-500 mt-2">Interactive Daily Schedule & Logistics</p>
        <div id="last-updated" class="text-xs text-gray-400 mt-2"></div>
    </header>

    <div id="tabs-container" class="flex flex-wrap justify-center gap-2 mb-8 p-4 bg-white rounded-xl shadow-md">
        <!-- Day Tabs will be rendered here -->
    </div>

    <div id="filters-container" class="flex flex-wrap gap-4 mb-6 p-4 bg-white rounded-xl shadow-md">
        <!-- Filters will be rendered here (now as dropdowns) -->
    </div>

    <div id="content-container" class="bg-white p-6 rounded-xl shadow-lg">
        <!-- Timeline content will be rendered here -->
    </div>
</div>

<script type="module">
    // --- Firebase imports (Kept for environment compatibility) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Global Variables (Provided by Canvas) ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    
    // --- Firebase Initialization ---
    let app, db, auth;
    if (Object.keys(firebaseConfig).length > 0) {
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Authentication logic
            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    // Sign in with custom token if available, otherwise anonymously
                    (async () => {
                        try {
                            if (initialAuthToken) {
                                await signInWithCustomToken(auth, initialAuthToken);
                            } else {
                                await signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase sign-in failed:", error);
                            // Fallback to anonymous sign-in if custom token fails
                            if (!auth.currentUser) {
                                await signInAnonymously(auth).catch(err => console.error("Anonymous sign-in failed:", err));
                            }
                        }
                    })();
                }
            });
        } catch (error) {
            console.error("Firebase initialization failed:", error);
        }
    }

    // --- Core Itinerary Logic ---
    let itineraryData = [];
    let currentDay = '';
    let activeFilters = { staff: 'All', group: 'All' }; // State for filters
    
    // Define staff assignments that should always be visible regardless of specific staff filter
    const MANDATORY_STAFF_ASSIGNMENTS = ['All Staff', 'UK Staff'];	

    const loadingIndicator = document.getElementById('loadingIndicator');
    const tabsContainer = document.getElementById('tabs-container');
    const contentContainer = document.getElementById('content-container');
    const filtersContainer = document.getElementById('filters-container');	
    const lastUpdatedElement = document.getElementById('last-updated');

    // RESTORED: Fetching from the Google Sheet CSV export URL provided by the user
    // This URL provides the live, published version of the spreadsheet.
    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRip3XVrk7VVTw8BTxJIFiEfr26jDhhuyMnGBDrB191c3wjVaz3DJ4ra4ZMrvXW0HbNAMl28rxMrqcB/pub?gid=1836297205&single=true&output=csv';	

    // Cached column headers (These are the desired, correct headers)
    let dateHeader = 'Day/Date';
    let timeHeader = 'Time';
    let activityHeader = 'Activity';
    let locationHeader = 'Location';
    let detailsHeader = 'Logistics';
    let extraDetailsHeader = 'Further Details'; 
    let staffHeader = 'Staff Allocation';
    let groupHeader = 'Group Applicable';

    const FALLBACK_HEADERS = [
        dateHeader, timeHeader, activityHeader, locationHeader, detailsHeader, staffHeader, groupHeader, extraDetailsHeader
    ];

    function showLoading(show) {
        loadingIndicator.style.display = show ? 'flex' : 'none';
    }

    // Function to handle the toggle of further details (exposed globally)
    window.toggleDetails = (activityId) => {
        const contentElement = document.getElementById(`details-content-${activityId}`);
        const buttonElement = document.getElementById(`details-button-${activityId}`);
        if (contentElement) {
            const isOpen = contentElement.classList.toggle('open');
            
            // Update button icon
            const icon = buttonElement.querySelector('svg');
            if (icon) {
                icon.innerHTML = isOpen 
                    ? '<path stroke-linecap="round" stroke-linejoin="round" d="M5 15l7-7 7 7" />' // Chevron up
                    : '<path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />'; // Chevron down
            }
        }
    };


    function parseCSV(text) {
        const lines = text.trim().split('\n');
        if (lines.length <= 1) return [];

        // 1. Try to parse headers normally
        const initialHeaders = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        let headers = initialHeaders;
        
        // 2. Check for merged header problem
        // If we detect 4 or fewer columns, but the first column name is very long, 
        // we assume the header row is mashed up and use the FALLBACK_HEADERS.
        if (headers.length <= 4 && headers[0].length > 30) {
            console.warn("Detected likely merged header issue. Overriding headers with fallback.");
            headers = FALLBACK_HEADERS;
        } else {
            // If normal headers are found, we'll use them, but we still map our target headers for safety
            console.log("Using detected headers:", headers);
            // This is handled in determineHeaders, but logging here helps debug the parser.
        }

        const data = [];

        // Start processing from the first data line (index 1)
        for (let i = 1; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;

            // Regex to split by comma, but ignore commas inside double quotes
            const row = line.match(/(".*?"|[^",\r\n]+)(?=\s*,|\s*$)/g) || [];
            
            // Clean up row content and match lengths
            const cleanedRow = row.map(c => c.trim().replace(/^"|"$/g, ''));
            
            if (cleanedRow.length > 0) {
                const item = {};
                
                // Use the detected or fallback headers
                headers.forEach((header, index) => {
                    if (cleanedRow[index] !== undefined) {
                        item[header] = cleanedRow[index];
                    } else {
                        item[header] = '';
                    }
                });
                data.push(item);
            }
        }
        return data.filter(item => Object.values(item).some(v => v)); // Filter out completely empty rows
    }


    function determineHeaders(data) {
        if (data.length === 0) return;
        const allHeaders = Object.keys(data[0]);

        // If we used fallback headers, they are already set and we just confirm existence
        const isFallbackActive = allHeaders.some(h => FALLBACK_HEADERS.includes(h));

        if (!isFallbackActive) {
            // Original logic to find dynamic headers if fallback wasn't triggered
            const dateKeywords = ['day', 'date', 'weekday'];
            const dateContentRegex = /(monday|tuesday|wednesday|thursday|friday|saturday|sunday|january|february|march|april|may|june|july|august|september|october|november|december)/i;
            
            let foundDateHeader = allHeaders.find((header) => {
                if (dateKeywords.some(keyword => header.toLowerCase().includes(keyword))) return true;
                for (let i = 0; i < Math.min(data.length, 10); i++) {
                    const content = data[i][header] || '';
                    if (content.trim() !== '' && dateContentRegex.test(content)) return true;
                }
                return false;
            });
            dateHeader = foundDateHeader || allHeaders[0];

            timeHeader = allHeaders.find(h => h.toLowerCase().includes('time')) || '';
            activityHeader = allHeaders.find(h => h.toLowerCase().includes('activity') || h.toLowerCase().includes('event') || h.toLowerCase().includes('title')) || '';
            locationHeader = allHeaders.find(h => h.toLowerCase().includes('location') || h.toLowerCase().includes('place')) || '';
            detailsHeader = allHeaders.find(h => h.toLowerCase().includes('logistics')) || allHeaders.find(h => h.toLowerCase().includes('details') || h.toLowerCase().includes('description')) || '';
            extraDetailsHeader = allHeaders.find(h => h.toLowerCase().includes('further details') || h.toLowerCase().includes('extra details')) || allHeaders.find(h => (h !== detailsHeader && h.toLowerCase().includes('notes'))) || ''; 
            staffHeader = allHeaders.find(h => h.toLowerCase().includes('staff allocation')) || '';
            groupHeader = allHeaders.find(h => h.toLowerCase().includes('group applicable')) || '';
        }
        
        console.log("Mapped Final Headers:", {dateHeader, timeHeader, activityHeader, locationHeader, detailsHeader, extraDetailsHeader, staffHeader, groupHeader});
    }

    function renderTabs(data) {
        // Collect all non-empty, unique day entries from the determined dateHeader column
        const uniqueDays = [];
        data.forEach(item => {
            const day = item[dateHeader] ? item[dateHeader].trim() : '';
            
            // Only add the day if it's not empty and not already in the list
            if (day && !uniqueDays.includes(day)) {
                uniqueDays.push(day);
            }
        });

        tabsContainer.innerHTML = '';

        if (uniqueDays.length === 0) {
            contentContainer.innerHTML = '<p class="text-center text-gray-500 p-8">No itinerary data found. Please ensure the Day/Date column is filled in your spreadsheet.</p>';
            return;
        }

        uniqueDays.forEach((day, index) => {
            const button = document.createElement('button');
            button.className = 'tab-button px-4 py-2 text-sm font-medium rounded-full transition duration-150 hover:bg-emerald-100 hover:text-emerald-700 text-gray-700 bg-white shadow-sm';
            button.textContent = day;
            button.onclick = () => switchDay(day);
            tabsContainer.appendChild(button);

            // Set the first non-empty unique day as the current day
            if (index === 0) {
                currentDay = day;
                button.classList.add('active');
            }
        });
        
        renderFilters(data); 
        renderContent(currentDay);
    }

    function switchDay(day) {
        currentDay = day;
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent === day) {
                btn.classList.add('active');
            }
        });
        // Reset filters when switching days
        activeFilters = { staff: 'All', group: 'All' };
        renderFilters(itineraryData);	
        renderContent(day);
    }
    
    function filterData(data) {
        return data.filter(item => {
            // Filter by Staff
            if (activeFilters.staff !== 'All') {
                const requiredStaff = activeFilters.staff;
                const itemStaffRaw = item[staffHeader] || '';
                // Split staff allocation by '/' and trim
                const itemStaffList = itemStaffRaw.split('/').map(s => s.trim());

                // Check 1: Does the activity explicitly include the selected staff member?
                const isExplicitlyAssigned = itemStaffList.includes(requiredStaff);

                // Check 2: Is the activity assigned to a mandatory, catch-all group?
                const isMandatoryAssignment = MANDATORY_STAFF_ASSIGNMENTS.some(mandatory =>	
                    itemStaffList.includes(mandatory)
                );
                
                // The item passes the staff filter if it's explicitly assigned to the staff, OR
                // if it's assigned to a mandatory, all-staff group (to prevent staff from missing team tasks).
                if (!isExplicitlyAssigned && !isMandatoryAssignment) {
                    return false;
                }
            }
            
            // Filter by Group (Group logic remains the same)
            if (activeFilters.group !== 'All') {
                const itemGroup = item[groupHeader] || '';
                // Check if the item's group applicable matches the active group filter
                if (itemGroup.trim() !== activeFilters.group) {
                    return false;
                }
            }

            return true;
        });
    }
    
    // New handler for dropdown change event
    function handleFilterChange(event, type) {
        const value = event.target.value;
        activeFilters[type] = value;
        // Re-render content with new filters applied
        renderContent(currentDay);	
    }
    window.handleFilterChange = handleFilterChange; // Expose globally

    function getUniqueValues(data, header) {
        if (!header) return [];
        const values = data.map(item => item[header]).filter(v => v && v.trim());
        // For Staff, split by '/' to handle multiple allocations (e.g., Gava / Josh)
        if (header === staffHeader) {
            const allStaff = values.flatMap(v => v.split('/').map(s => s.trim()));
            return [...new Set(allStaff)].sort();
        }
        return [...new Set(values)].sort();
    }
    
    // Helper to create a dropdown menu HTML structure
    function createDropdown(type, label, values) {
        const currentActive = activeFilters[type];
        
        let html = `<div class="flex flex-col sm:flex-row items-start sm:items-center gap-2">
            <label for="${type}-filter" class="font-semibold text-gray-700">${label}:</label>
            <select id="${type}-filter"	
                    onchange="window.handleFilterChange(event, '${type}')"	
                    class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 bg-white text-gray-800 w-full sm:w-auto min-w-[150px]">
                <option value="All" ${currentActive === 'All' ? 'selected' : ''}>-- All ${label} --</option>`;
        
        values.forEach(value => {
            if (value && value.trim()) {
                html += `<option value="${value}" ${currentActive === value ? 'selected' : ''}>${value}</option>`;
            }
        });

        html += `</select></div>`;
        return html;
    }


    function renderFilters(data) {
        filtersContainer.innerHTML = '';
        const dayData = data.filter(item => item[dateHeader] === currentDay);

        const staffValues = getUniqueValues(dayData, staffHeader);
        const groupValues = getUniqueValues(dayData, groupHeader);
        
        let filterHtml = '<div class="flex flex-col md:flex-row w-full gap-4">';
        
        // Staff Filter Dropdown
        if (staffValues.length > 0) {
            filterHtml += createDropdown('staff', 'Staff Allocation', staffValues);
        }

        // Group Filter Dropdown
        if (groupValues.length > 0) {
            filterHtml += createDropdown('group', 'Group Applicable', groupValues);
        }

        filterHtml += '</div>';
        filtersContainer.innerHTML = filterHtml;
    }


    function renderContent(day) {
        // Filter data to only show activities for the selected day
        let dayData = itineraryData.filter(item => item[dateHeader] === day);
        
        // Apply Filters (Staff/Group)
        const filteredData = filterData(dayData);

        if (filteredData.length === 0) {
            contentContainer.innerHTML = `<p class="text-center text-gray-500 font-semibold p-8">No activities scheduled for "${day}" matching the current filters.</p>`;
            return;
        }

        let timelineHtml = `
            <h2 class="text-3xl font-bold text-gray-800 mb-6">${day} Schedule</h2>
            <div class="space-y-8 p-4 border-l border-gray-200">
        `;
        
        filteredData.forEach((item, index) => {
            // Only render items with a valid activity name
            if (!item[activityHeader] || item[activityHeader].trim() === '') return;

            const time = item[timeHeader] || 'Time TBD';
            const activity = item[activityHeader] || 'Unknown Activity';
            const location = item[locationHeader];
            const logistics = detailsHeader ? item[detailsHeader] : ''; 
            const extraDetailsRaw = extraDetailsHeader ? item[extraDetailsHeader] : '';
            const extraDetails = extraDetailsRaw.trim(); // Use trimmed value for checks
            const staff = staffHeader ? item[staffHeader] : '';
            const group = groupHeader ? item[groupHeader] : '';
            
            // Unique ID for the collapsible elements
            const activityId = `${day.replace(/[^a-zA-Z0-9]/g, '')}-${index}`;

            // Determine button state and color
            const hasExtraDetails = extraDetails.length > 0;
            const buttonColor = hasExtraDetails ? 'bg-emerald-500 hover:bg-emerald-600 active:bg-emerald-700' : 'bg-gray-300 cursor-not-allowed';
            const buttonDisabled = hasExtraDetails ? '' : 'disabled';
            const buttonText = hasExtraDetails ? 'Further Details' : 'No Extra Details';

            timelineHtml += `
                <div class="timeline-item relative group pb-8 last:pb-0">
                    <div class="timeline-dot"></div>
                    
                    <div class="bg-white p-4 sm:p-6 rounded-xl border border-gray-100 shadow-md transition duration-300 group-hover:shadow-lg">
                        <div class="flex flex-col sm:flex-row sm:items-start justify-between">
                            <!-- Time -->
                            <div class="text-lg font-mono text-emerald-600 sm:w-1/4 mb-2 sm:mb-0">
                                ${time}
                            </div>
                            
                            <!-- Activity Content -->
                            <div class="sm:w-3/4">
                                <h3 class="text-xl font-semibold text-gray-900 mb-1">${activity}</h3>
                                
                                <!-- Location/Category -->
                                ${location ? `
                                    <p class="text-sm text-gray-500 mb-2 flex items-center">
                                        <svg class="w-4 h-4 mr-1 text-red-400" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path></svg>
                                        ${location}
                                    </p>
                                ` : ''}

                                <!-- Staff and Group Tags -->
                                <div class="flex flex-wrap gap-2 mt-2">
                                    ${staff ? `<span class="px-3 py-1 text-xs font-semibold text-sky-700 bg-sky-100 rounded-full">Staff: ${staff}</span>` : ''}
                                    ${group ? `<span class="px-3 py-1 text-xs font-semibold text-purple-700 bg-purple-100 rounded-full">Group: ${group}</span>` : ''}
                                </div>
                                
                                <!-- Logistics (Primary Details) -->
                                ${logistics ? `
                                    <p class="text-base text-gray-700 mt-3 p-3 bg-gray-50 border border-gray-200 rounded-lg">
                                        <span class="font-medium text-gray-600">Logistics:</span> ${logistics.replace(/\n/g, '<br>')}
                                    </p>
                                ` : ''}
                                
                                <!-- Further Details Button (Interactive) -->
                                <button id="details-button-${activityId}"
                                    onclick="${hasExtraDetails ? `window.toggleDetails('${activityId}')` : ''}"
                                    ${buttonDisabled}
                                    class="mt-3 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-full shadow-sm text-white transition duration-150 ease-in-out ${buttonColor} focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500">
                                    ${buttonText}
                                    <svg class="w-4 h-4 ml-2 -mr-1" id="icon-${activityId}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </button>

                                <!-- Further Details Content (Collapsible) -->
                                <div id="details-content-${activityId}" class="further-details-content">
                                    <!-- Using yellow background for visibility of secondary info -->
                                    <div class="text-sm text-gray-600 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                        <span class="font-bold text-yellow-700 block mb-1">Further Details:</span> 
                                        ${extraDetails.replace(/\n/g, '<br>')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });

        timelineHtml += `
            </div>
        `;
        
        contentContainer.innerHTML = timelineHtml;
    }

    async function loadItinerary() {
        showLoading(true);
        try {
            // Using exponential backoff for robustness
            const maxRetries = 3;
            let response;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    response = await fetch(csvUrl);
                    if (response.ok) break; // Success
                    if (i === maxRetries - 1) {
                         const errorMessage = `Error loading itinerary data: HTTP error! status: ${response.status}. 
                            Please ensure the Google Sheet is published to the web as a CSV file and the URL is correct. The current URL might be invalid.`;
                        throw new Error(errorMessage);
                    }
                    // Wait before retrying
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                } catch (e) {
                    if (i === maxRetries - 1) throw e;
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000));
                }
            }


            const csvText = await response.text();
            itineraryData = parseCSV(csvText);
            
            if (itineraryData.length === 0) {
                 throw new Error("The fetched CSV file is empty or contains no detectable data. Please check your spreadsheet content.");
            }

            // Determine headers once after loading data
            determineHeaders(itineraryData);
            
            renderTabs(itineraryData);
            
            // Update the last updated timestamp
            lastUpdatedElement.textContent = `Last data sync: ${new Date().toLocaleTimeString()}`;

        } catch (error) {
            console.error('Failed to load CSV:', error);
            contentContainer.innerHTML = `<p class="text-center text-red-500 font-semibold p-8">${error.message}</p>`;
        } finally {
            showLoading(false);
        }
    }

    // Initial setup and load
    document.addEventListener('DOMContentLoaded', () => {
        loadItinerary();
    });
</script>

</body>
</html>
