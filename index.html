<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gap Year Itinerary Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better aesthetics and fixed chat box */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            padding-bottom: 200px; /* Space for the fixed chat box */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 1rem;
        }
        .tab-button.active {
            background-color: #10b981; /* Emerald 500 */
            color: white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        .activity-table th {
            background-color: #f3f4f6;
        }
        .activity-table tr:nth-child(even) {
            background-color: #f9fafb;
        }
        .chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 90%;
            max-width: 400px;
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            max-height: 80vh;
        }
        .chat-messages {
            flex-grow: 1;
            padding: 1rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
        }
        .message-bubble {
            max-width: 85%;
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            word-wrap: break-word;
        }
        .user-message {
            align-self: flex-end;
            background-color: #3b82f6; /* Blue 500 */
            color: white;
            border-bottom-right-radius: 0.25rem;
        }
        .gemini-message {
            align-self: flex-start;
            background-color: #d1fae5; /* Green 100 */
            color: #065f46; /* Green 800 */
            border-bottom-left-radius: 0.25rem;
        }
        .gemini-source {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.5rem;
            padding-left: 0.5rem;
            border-left: 2px solid #a7f3d0;
        }
    </style>
</head>
<body class="bg-gray-50">

<div id="loadingIndicator" class="fixed inset-0 bg-white bg-opacity-75 flex items-center justify-center z-50">
    <div class="flex flex-col items-center">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-emerald-500"></div>
        <p class="mt-4 text-emerald-600 font-semibold">Loading Itinerary Data...</p>
    </div>
</div>

<div class="container">
    <header class="text-center mb-10 p-6 bg-white shadow-lg rounded-xl">
        <h1 class="text-4xl font-extrabold text-gray-800">Gap Year UK Itinerary</h1>
        <p class="text-lg text-gray-500 mt-2">Interactive Daily Schedule & Logistics</p>
    </header>

    <div id="tabs-container" class="flex flex-wrap justify-center gap-2 mb-8 p-4 bg-white rounded-xl shadow-md">
        <!-- Tabs will be rendered here -->
    </div>

    <div id="content-container" class="bg-white p-6 rounded-xl shadow-lg">
        <!-- Table content will be rendered here -->
    </div>
</div>

<!-- Gemini Chat Box -->
<div id="chat-box" class="chat-container">
    <!-- Chat Header -->
    <div id="chat-header" class="p-4 bg-emerald-500 text-white flex justify-between items-center rounded-t-xl cursor-pointer">
        <h3 class="text-xl font-bold">Itinerary Assistant (Gemini)</h3>
        <button id="toggle-chat-btn" class="text-2xl font-bold p-1 leading-none rounded-full hover:bg-emerald-400">&times;</button>
    </div>

    <!-- Chat Messages -->
    <div id="chat-messages" class="chat-messages h-64" style="display: none;">
        <!-- Initial Welcome Message -->
        <div class="message-bubble gemini-message">
            Hello! I'm your Itinerary Assistant. Ask me anything about your schedule, logistics, or general travel questions.
        </div>
        <!-- Messages will be appended here -->
    </div>

    <!-- Chat Input -->
    <div id="chat-input-area" class="chat-input-area" style="display: none;">
        <input type="text" id="chat-input" placeholder="Ask about the itinerary or UK travel..."
               class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-emerald-500 focus:border-emerald-500 mr-2 shadow-inner">
        <button id="send-btn"
                class="bg-emerald-500 hover:bg-emerald-600 text-white font-semibold py-3 px-4 rounded-lg transition duration-200 shadow-md flex items-center disabled:opacity-50">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 00.183.69l.006.006A1 1 0 003 18h14a1 1 0 00.894-1.447l-7-14z"></path></svg>
        </button>
    </div>
</div>

<script type="module">
    // Firebase imports are included even if not strictly used for this feature, 
    // to maintain the standard environment structure for authentication.
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- Global Variables (Provided by Canvas) ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
    const apiKey = ""; // Canvas provides the actual key at runtime

    // --- Firebase Initialization (Required for Env.) ---
    let app, db, auth;
    if (Object.keys(firebaseConfig).length > 0) {
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Authentication logic
            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    if (initialAuthToken) {
                        signInWithCustomToken(auth, initialAuthToken).catch(error => {
                            console.error("Firebase Custom Token sign-in failed:", error);
                            signInAnonymously(auth);
                        });
                    } else {
                        signInAnonymously(auth).catch(error => {
                            console.error("Firebase Anonymous sign-in failed:", error);
                        });
                    }
                }
            });
        } catch (error) {
            console.error("Firebase initialization failed:", error);
        }
    }

    // --- Core Itinerary Logic ---
    let itineraryData = [];
    let currentDay = '';

    const loadingIndicator = document.getElementById('loadingIndicator');
    const tabsContainer = document.getElementById('tabs-container');
    const contentContainer = document.getElementById('content-container');

    const csvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQWJ5w6j6-U73D_8q_sL0z8tM-oQkK4o9-g0c0-6O9I8/pub?gid=0&single=true&output=csv'; // Mock URL provided earlier

    function showLoading(show) {
        loadingIndicator.style.display = show ? 'flex' : 'none';
    }

    function parseCSV(text) {
        const lines = text.trim().split('\n');
        const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
        const data = [];

        for (let i = 1; i < lines.length; i++) {
            const row = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(c => c.trim().replace(/"/g, ''));
            if (row.length === headers.length) {
                const item = {};
                headers.forEach((header, index) => {
                    item[header] = row[index] || '';
                });
                data.push(item);
            } else if (row.some(c => c.length > 0)) {
                console.warn(`Skipping malformed row ${i + 1}: ${lines[i]}`);
            }
        }
        return data;
    }

    function renderTabs(data) {
        const uniqueDays = [...new Set(data.map(item => item['Day/Date']).filter(d => d))];
        tabsContainer.innerHTML = '';

        uniqueDays.forEach((day, index) => {
            const button = document.createElement('button');
            button.className = 'tab-button px-4 py-2 text-sm font-medium rounded-full transition duration-150 hover:bg-emerald-100 hover:text-emerald-700 text-gray-700 bg-white shadow-sm';
            button.textContent = day;
            button.onclick = () => switchDay(day);
            tabsContainer.appendChild(button);

            if (index === 0) {
                currentDay = day;
                button.classList.add('active');
            }
        });
        if (uniqueDays.length > 0) {
            renderContent(currentDay);
        } else {
            contentContainer.innerHTML = '<p class="text-center text-gray-500 p-8">No itinerary data found or CSV is empty.</p>';
        }
    }

    function switchDay(day) {
        currentDay = day;
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent === day) {
                btn.classList.add('active');
            }
        });
        renderContent(day);
    }

    function renderContent(day) {
        const dayData = itineraryData.filter(item => item['Day/Date'] === day);
        if (dayData.length === 0) {
            contentContainer.innerHTML = `<p class="text-center text-gray-500 p-8">No activities scheduled for ${day}.</p>`;
            return;
        }

        let tableHtml = `
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">${day} Activities</h2>
            <div class="overflow-x-auto rounded-lg border border-gray-200">
            <table class="min-w-full divide-y divide-gray-200 activity-table">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Activity</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Location</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Logistics</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
        `;

        dayData.forEach(item => {
            tableHtml += `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${item['Time'] || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-700">${item['Activity Description'] || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-700">${item['Location'] || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-700">${item['Logistics / Notes'] || '-'}</td>
                </tr>
            `;
        });

        tableHtml += `
                </tbody>
            </table>
            </div>
        `;
        contentContainer.innerHTML = tableHtml;
    }

    async function loadItinerary() {
        showLoading(true);
        try {
            const response = await fetch(csvUrl);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const csvText = await response.text();
            itineraryData = parseCSV(csvText);
            renderTabs(itineraryData);
        } catch (error) {
            console.error('Failed to load CSV:', error);
            contentContainer.innerHTML = `<p class="text-center text-red-500 p-8">Error loading itinerary data: ${error.message}. Please check the CSV link.</p>`;
        } finally {
            showLoading(false);
        }
    }

    // --- Gemini Chat Logic ---

    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('chat-input');
    const sendBtn = document.getElementById('send-btn');
    const chatHeader = document.getElementById('chat-header');
    const chatInputArea = document.getElementById('chat-input-area');
    const toggleChatBtn = document.getElementById('toggle-chat-btn');

    let isChatOpen = false;

    // Initially hide chat content
    chatMessages.style.display = 'none';
    chatInputArea.style.display = 'none';

    // Toggle chat box visibility
    function toggleChat() {
        isChatOpen = !isChatOpen;
        chatMessages.style.display = isChatOpen ? 'flex' : 'none';
        chatInputArea.style.display = isChatOpen ? 'flex' : 'none';
        toggleChatBtn.textContent = isChatOpen ? 'âˆ’' : '+';
        document.getElementById('chat-box').classList.toggle('max-h-80', isChatOpen);
        document.getElementById('chat-box').classList.toggle('max-h-16', !isChatOpen);
        if (isChatOpen) {
            scrollToBottom();
        }
    }
    toggleChatBtn.addEventListener('click', toggleChat);
    chatHeader.addEventListener('click', toggleChat); // Click anywhere on header to toggle

    function appendMessage(text, sender, sources = []) {
        const bubble = document.createElement('div');
        bubble.className = `message-bubble ${sender === 'user' ? 'user-message' : 'gemini-message'}`;
        
        let contentHtml = `<p>${text}</p>`;

        if (sender === 'gemini' && sources.length > 0) {
            contentHtml += `<div class="gemini-source mt-2 text-xs">
                <p class="font-bold mb-1">Sources:</p>
                <ul>
                    ${sources.map(s => `<li><a href="${s.uri}" target="_blank" class="hover:underline">${s.title || s.uri}</a></li>`).join('')}
                </ul>
            </div>`;
        }

        bubble.innerHTML = contentHtml;
        chatMessages.appendChild(bubble);
        scrollToBottom();
    }

    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    function createLoader() {
        const loader = document.createElement('div');
        loader.id = 'gemini-loader';
        loader.className = 'message-bubble gemini-message flex items-center';
        loader.innerHTML = `
            <div class="animate-pulse flex space-x-2">
                <div class="w-2 h-2 bg-emerald-600 rounded-full"></div>
                <div class="w-2 h-2 bg-emerald-600 rounded-full"></div>
                <div class="w-2 h-2 bg-emerald-600 rounded-full"></div>
            </div>
        `;
        chatMessages.appendChild(loader);
        scrollToBottom();
        return loader;
    }

    async function fetchWithExponentialBackoff(apiUrl, payload, maxRetries = 5) {
        for (let attempt = 0; attempt < maxRetries; attempt++) {
            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (response.status === 429 || response.status >= 500) {
                    if (attempt === maxRetries - 1) throw new Error("API request failed after all retries.");
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    continue; // Retry
                }

                if (!response.ok) {
                    throw new Error(`API returned status ${response.status}`);
                }

                return response.json();

            } catch (error) {
                if (attempt === maxRetries - 1) throw error;
                const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }

    async function sendMessage() {
        const userQuery = chatInput.value.trim();
        if (!userQuery) return;

        appendMessage(userQuery, 'user');
        chatInput.value = '';
        sendBtn.disabled = true;

        const loader = createLoader();
        
        // 1. Prepare Context and Payload
        const itineraryContext = JSON.stringify(itineraryData, null, 2);
        const systemPrompt = `You are a helpful and detailed itinerary assistant named 'Gemini'. The user is asking questions about the following travel plan. Base your primary answers on this data first. If the user asks a general question (like about weather, transportation, or local attractions not in the itinerary), use Google Search to provide an answer.

ITINERARY DATA:
---
${itineraryContext}
---

Answer all questions concisely and clearly. If you cannot find the answer in the itinerary, state that and then use Google Search for general information if applicable.`;
        
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            // Enable Google Search for grounding general knowledge questions
            tools: [{ "google_search": {} }],
            systemInstruction: {
                parts: [{ text: systemPrompt }]
            },
        };

        try {
            const result = await fetchWithExponentialBackoff(apiUrl, payload);
            
            // 2. Process Response
            const candidate = result.candidates?.[0];
            let responseText = "I apologize, but I couldn't generate a response for that query.";
            let sources = [];

            if (candidate && candidate.content?.parts?.[0]?.text) {
                responseText = candidate.content.parts[0].text;
                
                const groundingMetadata = candidate.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    sources = groundingMetadata.groundingAttributions
                        .map(attribution => ({
                            uri: attribution.web?.uri,
                            title: attribution.web?.title,
                        }))
                        .filter(source => source.uri && source.title); // Ensure sources are valid
                }
            }

            // 3. Display Response
            chatMessages.removeChild(loader);
            appendMessage(responseText, 'gemini', sources);

        } catch (error) {
            console.error("Gemini API Error:", error);
            if (chatMessages.contains(loader)) {
                chatMessages.removeChild(loader);
            }
            appendMessage("Error: Could not connect to the assistant. Please try again.", 'gemini');
        } finally {
            sendBtn.disabled = false;
        }
    }

    sendBtn.addEventListener('click', sendMessage);
    chatInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // Initial load of the itinerary when the script executes
    loadItinerary();
</script>

</body>
</html>
